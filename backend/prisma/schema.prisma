// Prisma schema for VnPeteria Game Backend
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== USERS ====================

model User {
  id              String    @id @default(uuid())
  email           String    @unique
  username        String    @unique
  passwordHash    String    @map("password_hash")
  level           Int       @default(1)
  xp              Int       @default(0)
  coins           Int       @default(1000)
  gems            Int       @default(50)
  pokeballs       Int       @default(5)
  huntTickets     Int       @default(5) @map("hunt_tickets")
  battleTickets   Int       @default(20) @map("battle_tickets")
  lastTicketReset DateTime  @default(now()) @map("last_ticket_reset")
  lastQuestReset  DateTime  @default(now()) @map("last_quest_reset")
  petCount        Int       @default(0) @map("pet_count")
  itemCount       Int       @default(0) @map("item_count")
  battlesWon      Int       @default(0) @map("battles_won")
  battlesLost     Int       @default(0) @map("battles_lost")
  huntsCompleted  Int       @default(0) @map("hunts_completed")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  pets            Pet[]
  userItems       UserItem[]
  battles         Battle[]
  hunts           Hunt[]
  huntSessions    HuntSession[]
  battleSessions  BattleSession[]
  favoritePets    FavoritePet[]
  userQuests      UserQuest[]

  @@map("users")
}

// ==================== PETS ====================

model Pet {
  id              String    @id @default(uuid())
  ownerId         String    @map("owner_id")
  species         String
  nickname        String?
  rarity          String
  level           Int       @default(1)
  xp              Int       @default(0)
  hp              Int
  maxHp           Int       @map("max_hp")
  attack          Int
  defense         Int
  speed           Int
  // Individual Values (IVs) - random stats generated on capture (0-15)
  ivHp            Int       @default(0) @map("iv_hp")
  ivAttack        Int       @default(0) @map("iv_attack")
  ivDefense       Int       @default(0) @map("iv_defense")
  ivSpeed         Int       @default(0) @map("iv_speed")
  evolutionStage  Int       @default(1) @map("evolution_stage")
  mood            Int       @default(100)
  lastFed         DateTime? @map("last_fed")
  isForSale       Boolean   @default(false) @map("is_for_sale")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  owner           User      @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  moves           PetMove[]
  battles         Battle[]
  favoritedBy     FavoritePet[]

  @@index([ownerId])
  @@map("pets")
}

// ==================== FAVORITE PETS ====================

model FavoritePet {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  petId     String   @map("pet_id")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  pet  Pet  @relation(fields: [petId], references: [id], onDelete: Cascade)

  @@unique([userId, petId])
  @@index([userId])
  @@index([petId])
  @@map("favorite_pets")
}

// ==================== ITEMS (Static Catalog) ====================

model Item {
  id              String    @id
  name            String
  description     String
  type            String    // Consumable, StatBoost, Evolution, Cosmetic
  rarity          String
  effectHp        Int?      @map("effect_hp")
  effectAttack    Int?      @map("effect_attack")
  effectDefense   Int?      @map("effect_defense")
  effectSpeed     Int?      @map("effect_speed")
  effectXpBoost   Int?      @map("effect_xp_boost")
  isPermanent     Boolean   @default(false) @map("is_permanent")
  priceCoins      Int?      @map("price_coins")
  priceGems       Int?      @map("price_gems")
  imageUrl        String    @map("image_url")

  userItems       UserItem[]

  @@map("items")
}

// ==================== USER INVENTORY ====================

model UserItem {
  userId          String    @map("user_id")
  itemId          String    @map("item_id")
  quantity        Int       @default(0)

  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  item            Item      @relation(fields: [itemId], references: [id])

  @@id([userId, itemId])
  @@index([userId])
  @@map("user_items")
}

// ==================== REGIONS (Static) ====================

model Region {
  id              String    @id
  name            String
  description     String
  difficulty      String
  energyCost      Int       @map("energy_cost")
  coinsCost       Int       @map("coins_cost")
  imageUrl        String    @map("image_url")
  unlockLevel     Int       @default(1) @map("unlock_level")

  spawns          RegionSpawn[]
  hunts           Hunt[]
  huntSessions    HuntSession[]

  @@map("regions")
}

// ==================== SPAWN RATES (Static) ====================

model RegionSpawn {
  id              String    @id @default(uuid())
  regionId        String    @map("region_id")
  species         String
  rarity          String
  spawnRate       Float     @map("spawn_rate")
  minLevel        Int       @map("min_level")
  maxLevel        Int       @map("max_level")

  region          Region    @relation(fields: [regionId], references: [id])

  @@index([regionId])
  @@map("region_spawns")
}

// ==================== HUNT SESSIONS (Active) ====================

model HuntSession {
  id              String    @id @default(uuid())
  userId          String    @map("user_id")
  regionId        String    @map("region_id")
  encountersData  Json?     @map("encounters_data") // Store current encounters
  createdAt       DateTime  @default(now()) @map("created_at")

  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  region          Region    @relation(fields: [regionId], references: [id])

  @@index([userId])
  @@map("hunt_sessions")
}

// ==================== HUNT HISTORY ====================

model Hunt {
  id              String    @id @default(uuid())
  userId          String    @map("user_id")
  regionId        String    @map("region_id")
  petsCaught      Int       @default(0) @map("pets_caught")
  xpEarned        Int       @default(0) @map("xp_earned")
  coinsEarned     Int       @default(0) @map("coins_earned")
  createdAt       DateTime  @default(now()) @map("created_at")
  completedAt     DateTime? @map("completed_at")

  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  region          Region    @relation(fields: [regionId], references: [id])

  @@index([userId])
  @@map("hunts")
}

// ==================== OPPONENTS (Static) ====================

model Opponent {
  id              String    @id
  name            String
  species         String
  level           Int
  difficulty      String
  hp              Int
  maxHp           Int       @map("max_hp")
  attack          Int
  defense         Int
  speed           Int
  rewardXp        Int       @map("reward_xp")
  rewardCoins     Int       @map("reward_coins")
  unlockLevel     Int       @default(1) @map("unlock_level")
  imageUrl        String    @map("image_url")

  moves           OpponentMove[]
  battles         Battle[]
  battleSessions  BattleSession[]

  @@map("opponents")
}

// ==================== BATTLE SESSIONS (Active) ====================

model BattleSession {
  id              String    @id @default(uuid())
  userId          String    @map("user_id")
  petId           String    @map("pet_id")
  opponentId      String    @map("opponent_id")
  battleType      String    @map("battle_type") // event, exp, material
  startedAt       DateTime  @default(now()) @map("started_at")

  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  opponent        Opponent  @relation(fields: [opponentId], references: [id])

  @@index([userId])
  @@map("battle_sessions")
}

// ==================== BATTLE HISTORY ====================

model Battle {
  id              String    @id @default(uuid())
  userId          String    @map("user_id")
  petId           String    @map("pet_id")
  opponentId      String    @map("opponent_id")
  battleType      String    @map("battle_type")
  result          String    // victory, defeat
  xpEarned        Int       @map("xp_earned")
  coinsEarned     Int       @map("coins_earned")
  turnsTaken      Int?      @map("turns_taken")
  createdAt       DateTime  @default(now()) @map("created_at")

  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  pet             Pet       @relation(fields: [petId], references: [id])
  opponent        Opponent  @relation(fields: [opponentId], references: [id])

  @@index([userId, createdAt])
  @@map("battles")
}

// ==================== MOVES (Static Reference) ====================

model Move {
  id              String    @id
  name            String
  type            String    // Physical, Special, Status
  element         String    // Fire, Water, Grass, etc.
  power           Int
  accuracy        Float
  description     String

  petMoves        PetMove[]
  opponentMoves   OpponentMove[]

  @@map("moves")
}

// ==================== PET MOVES (Junction) ====================

model PetMove {
  petId           String    @map("pet_id")
  moveId          String    @map("move_id")
  pp              Int
  maxPp           Int       @map("max_pp")

  pet             Pet       @relation(fields: [petId], references: [id], onDelete: Cascade)
  move            Move      @relation(fields: [moveId], references: [id])

  @@id([petId, moveId])
  @@map("pet_moves")
}

// ==================== OPPONENT MOVES (Junction) ====================

model OpponentMove {
  opponentId      String    @map("opponent_id")
  moveId          String    @map("move_id")

  opponent        Opponent  @relation(fields: [opponentId], references: [id])
  move            Move      @relation(fields: [moveId], references: [id])

  @@id([opponentId, moveId])
  @@map("opponent_moves")
}

// ==================== QUEST TEMPLATES (Static) ====================

model QuestTemplate {
  id              String    @id
  name            String
  description     String
  type            String    // daily, weekly, special
  category        String    // hunt, battle, evolution, collection, social
  targetType      String    @map("target_type")  // catch_pokemon, win_battles, evolve_pet, etc.
  targetCount     Int       @map("target_count") // How many to complete
  targetSpecies   String?   @map("target_species") // Optional: specific species required
  targetRarity    String?   @map("target_rarity")  // Optional: specific rarity required
  rewardCoins     Int       @default(0) @map("reward_coins")
  rewardGems      Int       @default(0) @map("reward_gems")
  rewardXp        Int       @default(0) @map("reward_xp")
  rewardItemId    String?   @map("reward_item_id") // Optional item reward
  rewardItemQty   Int?      @map("reward_item_qty")
  difficulty      String    @default("normal") // easy, normal, hard
  isActive        Boolean   @default(true) @map("is_active")
  sortOrder       Int       @default(0) @map("sort_order")

  userQuests      UserQuest[]

  @@map("quest_templates")
}

// ==================== USER QUESTS (Active) ====================

model UserQuest {
  id              String    @id @default(uuid())
  userId          String    @map("user_id")
  questId         String    @map("quest_id")
  progress        Int       @default(0)
  status          String    @default("active") // active, completed, claimed, expired
  assignedAt      DateTime  @default(now()) @map("assigned_at")
  expiresAt       DateTime? @map("expires_at")
  completedAt     DateTime? @map("completed_at")
  claimedAt       DateTime? @map("claimed_at")

  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  quest           QuestTemplate @relation(fields: [questId], references: [id])

  @@unique([userId, questId, assignedAt])
  @@index([userId, status])
  @@map("user_quests")
}

// ==================== EVENTS (Time-limited) ====================

model Event {
  id              String    @id @default(uuid())
  name            String
  description     String
  type            String    // hunt_boost, rare_spawn, double_xp, special_hunt
  startTime       DateTime  @map("start_time")
  endTime         DateTime  @map("end_time")
  isActive        Boolean   @default(true) @map("is_active")
  
  // Event configuration (JSON for flexibility)
  config          Json?     // { spawnBonus: 0.5, xpMultiplier: 2, featuredSpecies: ["Pikachu"] }
  
  // Optional region-specific events
  regionId        String?   @map("region_id")
  
  // Banner/display
  bannerUrl       String?   @map("banner_url")
  priority        Int       @default(0) // Higher = show first

  eventSpawns     EventSpawn[]

  @@index([startTime, endTime])
  @@index([isActive])
  @@map("events")
}

// ==================== EVENT SPAWNS (Special spawn rates during events) ====================

model EventSpawn {
  id              String    @id @default(uuid())
  eventId         String    @map("event_id")
  species         String
  rarity          String
  spawnRate       Float     @map("spawn_rate") // Override spawn rate during event
  minLevel        Int       @map("min_level")
  maxLevel        Int       @map("max_level")
  isGuaranteed    Boolean   @default(false) @map("is_guaranteed") // First encounter guaranteed?

  event           Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@map("event_spawns")
}
